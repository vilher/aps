
const express = require("express");
const bodyParser= require("body-parser");
const mysql = require('mysql');
const AES = require('mysql-aes-binary');

const app = express();
app.use(bodyParser.urlencoded({extended: true}));

const con = mysql.createConnection({
    host: "localhost",
    user: "root",
    password: "",
    database: 'viktorina'
  });
  const key="lokyslokiukas";

//get smth data
app.get("/:data", function(req,res){
        con.query("SELECT * FROM "+req.params.data,function (err, result) {
          if (err){ res.send(false);}
          res.send(result);
        });
});
//inserting users by email, name, surname and password
app.post("/user/:where", function(req,res){
    var sql = "INSERT INTO"+ req.params.where+ "(Elektroninis_pastas, Vardas,Pavarde,Slaptazodis) VALUES ('"+req.body.email+"', '"+req.body.name+"', '"+req.body.surname+"','"+AES.encrypt(req.body.password, key) +"')";
    con.query(sql, function (err, result) {
      if (err){ res.send(false);}
      else{res.send(true);}
  });
});
//delete user from name
app.delete("/user/:name",function(req,res) {
          var sql = "DELETE FROM users WHERE Slapyvardis='"+req.params.name+"'";
               con.query(sql, function (err, result){
                  if (err) { res.send(false);}
                  else{res.send(true);}
        });
});
//get user by username
app.get("/user/:username", function(req,res){
        con.query("SELECT * FROM users WHERE Slapyvardis= '"+req.params.username+"'",function (err, result) {
          if (err) { res.send({"username": "error"});}
          else{
            if(result.length===0)res.send(false);
            else{res.send(result);}
          }
        });
});
//change password or username by username
app.patch("/user/:who", function(req,res){
        if(req.body.password!==undefined && req.body.username!==undefined){
          var sql = "UPDATE users SET Slapyvardis = '"+req.body.username+"', Slaptazodis = '"+AES.encrypt(req.body.password, key)+"' WHERE Slapyvardis= '"+req.params.who+"'";
        }
        else if(req.body.password!==undefined)var sql = "UPDATE users SET Slaptazodis = '"+AES.encrypt(req.body.password, key)+"' WHERE Slapyvardis = '"+req.params.who+"'";
        else if(req.body.username!==undefined){
          var sql = "UPDATE users SET Slapyvardis = '"+req.body.username+"' WHERE Slapyvardis= '"+req.params.who+"'";
        }
        con.query(sql, function (err, result) {
          if (err) { res.send(false);}
          else{res.send(true);}
        });
});

app.listen(5000, function(){
    console.log("Server is running on port 5000");
});